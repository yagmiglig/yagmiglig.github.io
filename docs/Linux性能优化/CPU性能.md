# CPU性能

## 平均负载

> 平均负载是指单位时间内，系统处于可运行状态和不可中断状态的平均进程数，也就是平均活跃进程数。

可运行状态：`Running`或`Runnable`状态

不可中断状态：进程则正处于内核态关键流程中的进程，并且这些流程是不可打断的，比如最常见的是等待硬件设备的 I/O 响应，也就是我们在 ps 命令中看到的 D 状态（`Uninterruptible Sleep`，也称为 `Disk Sleep`）的进程

## 上下文切换

- 进程上下文切换
- 线程上下文切换
- 中断上下文切换

### 进程上下文切换

> 从一个进程切换到另一个进程运行

进程上下文切换场景：

- 进程CPU时间片耗尽，被系统挂起，切换到其他正在等待CPU的进程。
- 进程在系统资源不足（比如内存不足）时，要等到资源满足后才可以运行，这个时候进程也会被挂起，并由系统调度其他进程运行。
- 进程通过`sleep`主动挂起，也会重新调度
- 有优先级更高的进程运行时，为了保证高优先级进程的运行，当前进程会被挂起，由高优先级进程来运行。

*系统调用与进程上下文切换*
> 系统调用过程是在同一个进程执行，我们通常称之为特权模式切换，而不是上下文切换，一次系统调用的过程发生了两次CPU上下文切换。

#### 进程状态

- R (`Running` 或 `Runnable`)，表示进程在 CPU 的就绪队列中，正在运行或者正在等待运行。
- D (`Disk Sleep`)，不可中断状态睡眠（`Uninterruptible Sleep`），一般表示进程正在跟硬件交互，并且交互过程不允许被其他进程或中断打断。
- Z (`Zombie`)，僵尸进程，进程实际上已经结束了，但是父进程还没有回收它的资源（比如进程的描述符、PID 等）。
- S (`Interruptible Sleep`)，可中断状态睡眠，表示进程因为等待某个事件而被系统挂起。当进程等待的事件发生时，它会被唤醒并进入 R 状态。
- I (`Idle`)，空闲状态，用在不可中断睡眠的内核线程上

### 线程上下文切换

线程和进程

- 线程是系统调度的基本单位，进程是资源拥有的基本单位。
- 当进程只有一个线程时，可以认为进程就等于线程。
- 当进程拥有多个线程时，这些线程会共享相同的虚拟内存和全局变量等资源。这些资源在上下文切换时是不需要修改的。
- 线程也有自己的私有数据，比如栈和寄存器等，这些在上下文切换时也是需要保存的。

上下文切换

- 前后两个线程属于不同进程。此时，因为资源不共享，所以切换过程就跟进程上下文切换是一样。
- 前后两个线程属于同一个进程。此时，因为虚拟内存是共享的，所以在切换时，虚拟内存这些资源就保持不动，只需要切换线程的私有数据、寄存器等不共享的数据。

### 中断上下文

> 中断是一种异步的事件处理机制，可以提高系统的并发处理能力。

> 中断上下文切换并不涉及到进程的用户态。所以，即便中断过程打断了一个正处在用户态的进程，也不需要保存和恢复这个进程的虚拟内存、全局变量等用户态资源。中断上下文，其实只包括内核态中断服务程序执行所必需的状态，包括 CPU 寄存器、内核堆栈、硬件中断参数等。

Linux将中断分为两部分：

1. 上半部用来快速处理中断，它在中断禁止模式下运行，主要处理跟硬件紧密相关的或时间敏感的工作。（硬中断，处理硬件请求，特点是快速执行）
2. 下半部用来延迟处理上半部未完成的工作，通常以内核线程的方式运行。（软中断，由内核触发，特点是延迟执行）

## 常用工具

### mpstat



![指标找工具](https://static001.geekbang.org/resource/image/59/ec/596397e1d6335d2990f70427ad4b14ec.png)

![工具找指标](https://static001.geekbang.org/resource/image/b0/ca/b0c67a7196f5ca4cc58f14f959a364ca.png)

![命令](https://static001.geekbang.org/resource/image/7a/17/7a445960a4bc0a58a02e1bc75648aa17.png)